apiVersion: apps/v1
kind: Deployment
metadata:
  name: free5gc-upf1
  labels:
    app: free5gc-upf1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: free5gc-upf1
  template:
    metadata:
      labels:
        app: free5gc-upf1
      annotations:
        k8s.v1.cni.cncf.io/networks: free5gc-upf1-n3, free5gc-upf1-n4, free5gc-upf1-n6
    spec:
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      containers:
      - name: free5gc-upf1
        image: succassion/free5gc-compose_free5gc-upf-1
        imagePullPolicy: IfNotPresent
        securityContext:
          privileged: false
          capabilities:
              add: ["NET_ADMIN", "NET_RAW", "NET_BIND_SERVICE", "SYS_TIME"]
        command: ["/bin/sh", "-ec"]
        args: ["sleep 5 && ../config/upfipset.sh && ./free5gc-upfd -f ../config/upfcfg.yaml"]
        ports:
        - name: if-n3
          containerPort: 2152
          protocol: UDP
        - name: if-n4
          containerPort: 8805
          protocol: UDP
        volumeMounts:
        - mountPath: /free5gc/config/upfcfg.yaml
          name: upfcfg
          subPath: upfcfg.yaml
        - mountPath: /free5gc/config/free5gc.yaml
          name: free5gc
          subPath: free5gc.yaml
        - mountPath: /free5gc/config/upfipset.sh
          name: upfipset
          readOnly: true
          subPath: upfipset.sh
        - mountPath: /dev/net/tun
          name: tun-dev
      volumes:
      - name: upfcfg
        configMap:
          name: free5gc-upf1-configmap
          items:
          - key: upfcfg.yaml
            path: upfcfg.yaml
      - name: free5gc
        configMap:
          name: free5gc-upf1-configmap
          items:
          - key: free5gc.yaml
            path: free5gc.yaml
      - name: upfipset
        configMap:
          name: free5gc-upf1-configmap
          defaultMode: 0700
          items:
          - key: upfipset.sh
            path: upfipset.sh
      - name: tun-dev
        hostPath:
          path: /dev/net/tun
